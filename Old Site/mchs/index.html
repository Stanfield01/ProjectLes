<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/leaflet.css" />
        <link rel="stylesheet" href="css/qgis2web.css" />
        <link rel="stylesheet" href="css/fontawesome-all.min.css" />
        <link rel="stylesheet" href="css/leaflet-measure.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="pdf/pdfmake.min.js"></script>
        <script src="pdf/vfs_fonts.js"></script>

        <!-- <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Varela" /> -->
        <style>
            #map {
                width: inherit;
                height: 80vh;
                z-index: 4;
            }
        </style>
        <title>Моделирование ЧС</title>
    </head>

    <body onload=" weather(68.804916,33.099987)">
        <div class="sidebar">
            <div class="in_sidebar choice_bar">
                <ul>
                    <li>
                        <a href="#"
                            ><img src="images/raindrop.svg" alt="" />
                            <p>Паводки</p>
                        </a>
                    </li>
                    <li>
                        <a href="snow_index.html"
                            ><img src="images/sneg.svg" alt="" />
                            <p>Лавины</p>
                        </a>
                    </li>
                    <div class="active_choice">
                    <li>
                        <a href="fire_index.html"
                            ><img src="images/fire.svg" alt="" />
                            <p>Пожары</p>
                        </a>
                    </li>
                    </div>
                </ul>
                <a href="https://www.mchs.gov.ru/" target="_self">
                    <img
                        src="images/MCHS_logo.png"
                        class="choice_logo"
                        alt=""
                    />
                </a>
            </div>
            <div class="sb_right">
                <a href="#">
                    <div class="in_sidebar faq_bar sbr">
                        <!-- <div style="float: left; width: 250px;" data-tooltip2='1. Выберите населенный пункт, нажимая на соответствующую форму ввода на верхней панели и на название н.п.
                            2. Измените уровень подтопления, нажимая на стрелочки в правой части формы ввода на верхней панели
                            
                            Для быстрой навигации по странице нажимайте на названия разделов в боковой панели (Карта, Погода, GIF анимация)
                            
                            Для открытия 3D модели подтопления нажмите на красную кнопку "Интерактивная 3D модель" на верхней панели. Обратите внимание на предупреждение о загрузке большого объема данных
                            
                            Когда введены нужные данные, для формирования отчета нажмите кнопку "Отчет" в нижней части боковой панели
                        '> -->
                        <span> Инструкция </span>
                        <!-- </div> -->
                        <!-- <div onclick="" class="hidden_faq"> -->
                        <div class="faq">
                          
                                Работа с системой
                            </p>
                            <br />
                            <p>
                                  <p>Ввод данных</p>
                            <p>
                                1. Выберите необходимую часть карты
                            </p>
                            <p>
                                2. Задайте площадь распространения пожара
                            </p>
                            <br />
                            <p>
                                Для быстрой навигации по странице нажимайте на
                                названия разделов в боковой панели (Карта,
                                Погода, GIF анимация)
                            </p>
                            <br />
                            <p>
                                Когда введены нужные данные будет просчитано предпологаемое распространение
                            </p>
                            <br />
                            <p>
                                Для изменения списка пользователей обратитесь к разработчикам
                            </p>
                        </div>
                    </div>
                </a>
                <div class="in_sidebar employee sbr">
                    <img src="images/user.svg" alt="" />
                    <div class="select_emp">
                        <input class="select__input" type="hidden" name="" />
                        <div class="select__head" id="selected_emp">
                            Выберите пользователя
                        </div>
                        <ul class="select__list" style="display: none">
                            <li class="select__item">Иван Иванов</li>
                            <li class="select__item">Егор Егоров</li>
                            <li class="select__item">Петр Петров</li>
                        </ul>
                    </div>
                </div>

                <div class="in_sidebar anchors_bar sbr">
                    <ul>
                        <li><a href="#anchor1">Карта</a></li>
                        <li><a href="#anchor2">Погода</a></li>
                    </ul>
                </div>

                <div class="in_sidebar weather-informer">
                    <table
                        cellpadding="0"
                        cellspacing="0"
                        width="158"
                        style="
                            border: solid 1px #466fd5;
                            font-family: Arial;
                            font-size: 12px;
                            background-color: #466fd5;
                        "
                    >
                        <tr>
                            <td>
                                <table
                                    width="100%"
                                    cellpadding="0"
                                    cellspacing="0"
                                >
                                    <tr>
                                        <td
                                            width="8"
                                            height="30"
                                            background="https://rp5.ru/informer/htmlinfa/topshl.png"
                                            bgcolor="#466FD5"
                                        ></td>
                                        <td
                                            width="*"
                                            align="center"
                                            background="https://rp5.ru/informer/htmlinfa/topsh.png"
                                            bgcolor="#466FD5"
                                        >
                                            <a
                                                class="changeName"
                                                style="
                                                    color: #ffffff;
                                                    font-family: Arial;
                                                    font-size: 12px;
                                                "
                                                href="https://rp5.ru/2005/ru"
                                            >
                                                <b id="townName">Варзуга</b>
                                            </a>
                                        </td>
                                        <td
                                            width="8"
                                            height="30"
                                            background="https://rp5.ru/informer/htmlinfa/topshr.png"
                                            bgcolor="#466FD5"
                                        ></td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td valign="top" style="padding: 0">
                                <iframe
                                    id="frame-weather"
                                    src="https://rp5.ru/htmla.php?id=2005&lang=ru&um=00000&bg=%23466FD5&ft=%23466FD5&fc=%23466FD5&c=%23000000&f=Arial&s=12&sc=1"
                                    width="253"
                                    height="109"
                                    frameborder="0"
                                    scrolling="no"
                                    style="margin: 0"
                                >
                                </iframe>
                            </td>
                        </tr>
                    </table>
                </div>

                <button class="give_results" onclick="create_pdf()">
                    Отчет
                </button>
            </div>
        </div>

        <div class="settings" >           
            <div style="display: inline-block; width: 180px;">
                <Button onclick="editMode()">Редактировать</Button>
            </div>
            <div style="display: inline-block; width: 180px;">
                <Button onclick="simulate()">Симулировать</Button>
            </div>
        </div>

                 <!--var dicpic; 
                 dicpic = L.imageOverlay('datasim/pic.png', [[70.000000, 29.000000], [66.000000, 42.000000]], {opacity:1.0}).addTo(map);  это было в классе главного контента-->
        <div class="main_content">
            <div class="d2_map mc">                    
                <p class="mc_header" id="anchor1">2D КАРТА МЕСТНОСТИ</p>
                <div class="smart_map">
                    <div id="map"></div>
                    <script src="js/qgis2web_expressions.js"></script>
                    <script src="js/leaflet.js"></script>
                    <script src="js/leaflet.rotatedMarker.js"></script>
                    <script src="js/leaflet.pattern.js"></script>
                    <script src="js/leaflet-hash.js"></script>
                    <script src="js/Autolinker.min.js"></script>
                    <script src="js/rbush.min.js"></script>
                    <script src="js/labelgun.min.js"></script>
                    <script src="js/labels.js"></script>
                    <script src="js/leaflet-measure.js"></script>
                    <script>
                        var highlightLayer;                        
                        var objOverlay;                    

                        function highlightFeature(e) {
                            highlightLayer = e.target;
                            if (
                                e.target.feature.geometry.type === 'LineString'
                            ) {
                                highlightLayer.setStyle({
                                    color: '#ffff00',
                                });
                            } else {
                                highlightLayer.setStyle({
                                    fillColor: '#ffff00',
                                    fillOpacity: 1,
                                });
                            }
                        }

                        var map = new L.map('map', {
                            zoomControl: true,
                            maxZoom: 28,
                            minZoom: 1,
                        }).fitBounds([
                            [68.897683, 32.963397],
                            [68.867508, 33.128933],
                        ]);

                        var hash = new L.Hash(map);
                        map.attributionControl.setPrefix(
                            '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>'
                        );
                        var autolinker = new Autolinker({
                            truncate: {
                                length: 30,
                                location: 'smart',
                            },
                        });
                        var measureControl = new L.Control.Measure({
                            position: 'topleft',
                            primaryLengthUnit: 'meters',
                            secondaryLengthUnit: 'kilometers',
                            primaryAreaUnit: 'sqmeters',
                            secondaryAreaUnit: 'hectares',
                        });
                        
                        measureControl.addTo(map);
                        document.getElementsByClassName(
                            'leaflet-control-measure-toggle'
                        )[0].innerHTML = '';
                        document.getElementsByClassName(
                            'leaflet-control-measure-toggle'
                        )[0].className += ' fas fa-ruler';
                        var bounds_group = new L.featureGroup([]);

                        

                        function setBounds() {}
                        map.createPane('pane_OpenStreetMap_0');
                        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
                        var layer_OpenStreetMap_0 = L.tileLayer(
                            'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
                            {
                                pane: 'pane_OpenStreetMap_0',
                                opacity: 0.8,
                                attribution: '',
                                minZoom: 1,
                                maxZoom: 28,
                                minNativeZoom: 0,
                                maxNativeZoom: 19,
                            }
                        );
                        layer_OpenStreetMap_0;
                        map.addLayer(layer_OpenStreetMap_0);

                        // Создание карты

                        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);

                        L.VirtualGrid = L.FeatureGroup.extend({
                        include: L.Mixin.Events,
                        options: {
                            cellSize: 64,
                            delayFactor: 2.5,
                            style: {
                            stroke: true,
                            color: '#3ac1f0',
                            dashArray: null,
                            lineCap: null,
                            lineJoin: null,
                            weight: 2,
                            opacity: 1,

                            fill: true,
                            fillColor: null, //same as color by default
                            fillOpacity: 0.5,

                            clickable: true
                            }
                        },
                        initialize: function(options){
                            L.Util.setOptions(this, options);
                            L.FeatureGroup.prototype.initialize.call(this, [], options);
                        },
                        onAdd: function(map){
                            L.FeatureGroup.prototype.onAdd.call(this, map);
                            this._map = map;
                            this._cells = [];
                            this._setupGrid(map.getBounds());

                            map.on("move", this._moveHandler, this);
                            map.on("zoomend", this._zoomHandler, this);
                            map.on("resize", this._resizeHandler, this);
                        },
                        onRemove: function(map){
                            L.FeatureGroup.prototype.onRemove.call(this, map);
                            map.off("move", this._moveHandler, this);
                            map.off("zoomend", this._zoomHandler, this);
                            map.off("resize", this._resizeHandler, this);
                        },

                        _clearLayer: function(e) {
                            this._cells = [];
                        },
                        _moveHandler: function(e){
                            this._renderCells(e.target.getBounds());
                        },
                        _zoomHandler: function(e){
                            this.clearLayers();
                            this._renderCells(e.target.getBounds());
                        },
                        _renderCells: function(bounds) {
                            var cells = this._cellsInBounds(bounds);
                            this.fire("newcells", cells);
                            for (var i = cells.length - 1; i >= 0; i--) {
                            var cell = cells[i];
                            if(this._loadedCells.indexOf(cell.id) === -1){
                                (function(cell, i){
                                setTimeout(this.addLayer.bind(this, L.rectangle(cell.bounds, this.options.style)), this.options.delayFactor*i);
                                }.bind(this))(cell, i);
                                this._loadedCells.push(cell.id);
                            }
                            }
                        },
                        _resizeHandler: function(e) {
                            this._setupSize();
                        },
                        _setupSize: function(){
                            this._rows = Math.ceil(this._map.getSize().x / this._cellSize);
                            this._cols = Math.ceil(this._map.getSize().y / this._cellSize);
                        },
                        _setupGrid: function(bounds){
                            this._origin = this._map.project(bounds.getNorthWest());
                            this._cellSize = this.options.cellSize;
                            this._setupSize();
                            this._loadedCells = [];
                            this.clearLayers();
                            this._renderCells(bounds);
                        },
                        _cellPoint:function(row, col){
                            var x = this._origin.x + (row*this._cellSize);
                            var y = this._origin.y + (col*this._cellSize);
                            return new L.Point(x, y);
                        },
                        _cellExtent: function(row, col){
                            var swPoint = this._cellPoint(row, col);
                            var nePoint = this._cellPoint(row-1, col-1);
                            var sw = this._map.unproject(swPoint);
                            var ne = this._map.unproject(nePoint);
                            return new L.LatLngBounds(ne, sw);
                        },
                        _cellsInBounds: function(bounds){
                            var offset = this._map.project(bounds.getNorthWest());
                            var center = bounds.getCenter();
                            var offsetX = this._origin.x - offset.x;
                            var offsetY = this._origin.y - offset.y;
                            var offsetRows = Math.round(offsetX / this._cellSize);
                            var offsetCols = Math.round(offsetY / this._cellSize);
                            var cells = [];
                            for (var i = 0; i <= this._rows; i++) {
                                for (var j = 0; j <= this._cols; j++) {
                                    var row = i-offsetRows;
                                    var col = j-offsetCols;
                                    var cellBounds = this._cellExtent(row, col);
                                    var cellId = row+":"+col;
                                    cells.push({
                                    id: cellId,
                                    bounds: cellBounds,
                                    distance:cellBounds.getCenter().distanceTo(center)
                                    });
                                }
                            }
                            cells.sort(function (a, b) {
                            return a.distance - b.distance;
                            });
                            return cells;
                        }
                        });

                        L.virtualGrid = function(url, options){
                            return new L.VirtualGrid(options);
                        };

                        L.virtualGrid({
                            cellSize: 64,
                            opacity: 1,
                        }).addTo(map);

                        
                        var edit_mode = false;
                        var simulate_mode = false;

                        var point;
                        var prev_point;
                        var sim_step = 1;

                        document.addEventListener('click', function(e) {
                            e = e || window.event;
                            var target = e.target || e.srcElement,
                                text = target.textContent || target.innerText;
                            
                            
                            // toggle color
                            if (target.toString() == '[object SVGPathElement]') {
                                if (edit_mode == true && simulate_mode == false && (target.getAttribute('style') == null || target.getAttribute('style') == 'fill: #3ac1f0')) {
                                    if (prev_point != null) {
                                        prev_point.setAttribute('style', 'fill: #3ac1f0');
                                    }
                                    prev_point = target;
                                    target.setAttribute('style', 'fill: red');
                                    point = target.getBoundingClientRect();
                                }
                            }
                        }, false);

                        function editMode() {
                            if (!edit_mode) {
                                simulate_mode = false;
                                sim_step = 1;
                                map.touchZoom.disable();
                                map.doubleClickZoom.disable();
                                map.scrollWheelZoom.disable();
                                map.boxZoom.disable();
                                map.keyboard.disable();
                                $(".leaflet-control-zoom").css("visibility", "hidden");
                                edit_mode = true;
                                map.dragging.disable();
                            }
                            else {
                                simulate_mode = false;
                                sim_step = 1;
                                map.touchZoom.enable();
                                map.doubleClickZoom.enable();
                                map.scrollWheelZoom.enable();
                                map.boxZoom.enable();
                                map.keyboard.enable();
                                $(".leaflet-control-zoom").css("visibility", "visible");
                                edit_mode = false;
                                map.dragging.enable();
                            }
                        };  

                        function simulate() {
                            simulate_mode = true;
                            sim_step++;
                            var cells = 2 * sim_step - 1;
                            for (var i = -cells / 2; i < cells / 2; i++) {
                                //alert(point.top.toString() + " " + point.left.toString());
                                //alert(document.elementFromPoint(point.left, point.top));
                                //alert(document.elementFromPoint(point.top, point.left));
                                document.elementFromPoint(point.left - 64 * i, point.top - 64 * sim_step + 96).setAttribute('style', 'fill: red');
                            }
                        }
                        
                    </script>
                </div>
                <hr />
                <div class="whitespace_omg"></div>
            </div>
            <div class="weather mc" style="height: 85vh">
                <p class="mc_header" id="anchor2">ПРОГНОЗ ПОГОДЫ</p>
                <hr />
                <div>&nbsp;</div>
                <div class="pricing-table row">
                    <div class="package">
                        <div></div>

                        <div class="time-actualy__title" id="col1">
                            Дни недели
                            <div class="timeActualy" id="timeActualy">
                                &nbsp; &nbsp; &nbsp;
                            </div>
                        </div>

                        <div>&nbsp; &nbsp; &nbsp;</div>

                        <div class="degrees-days__title" id="col2">
                            Температура
                            <div class="degrees__days" id="degrees__days"></div>
                        </div>

                        <div>&nbsp; &nbsp; &nbsp;</div>

                        <div class="pressure__title" id="col3">
                            Давление
                            <div class="pressure" id="pressure"></div>
                        </div>

                        <div>&nbsp; &nbsp; &nbsp;</div>

                        <div class="humidity__title" id="col4">
                            Влажность
                            <div class="humidity" id="humidity"></div>
                        </div>

                        <div>&nbsp; &nbsp; &nbsp;</div>

                        <div class="pop__title" id="col5">
                            Вероятность осадков
                            <div class="pop" id="pop"></div>
                        </div>

                        <div>&nbsp; &nbsp; &nbsp;</div>

                        <div class="wind__title" id="col6">
                            Скорость ветра
                            <div class="wind" id="wind"></div>
                        </div>

                        <div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <p>
                Проект разработан группой студентов МАГУ 3 курса направления
                подготовки "Прикладная математика и информатика" <br /><br />
                &copy; 2003
                <script>
                    new Date().getFullYear() > 2003 &&
                        document.write('-' + new Date().getFullYear());
                </script>
                Мурманский арктический государственный университет
            </p>
            <a href="http://www.masu.edu.ru/" target="_blank">
                <img src="images/MASU_logo.svg" alt="" />
            </a>
        </div>
        <script src="index.js"></script>
        <script src="pdf/pdf.js"></script>
        <script id="weathertown" src="assets/imgs/Варзуга/index.js"></script>
    </body>
</html>
